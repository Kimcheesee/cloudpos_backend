/**
 * @license MIT
 * @module @whoj/utils-vue@1.8.0
 * @copyright (c) 2023 Jonson B.
 */
'use strict';
const Resumable = require('resumablejs');
const vueDemi = require('vue-demi');
const utilsCore = require('@whoj/utils-core');
const composables_tryOnMounted = require('./tryOnMounted.cjs');
const composables_unrefOfEl = require('./unrefOfEl.cjs');
function useResumableUploader(options, target) {
  const files = vueDemi.ref([]);
  const uploader = vueDemi.ref();
  const findFile = (file) => {
    return files.value.find((item) => item.file.uniqueIdentifier === file.uniqueIdentifier && item.status !== "canceled");
  };
  const cancelFile = (file) => {
    const _file = findFile(file);
    if (_file) {
      _file.status = "canceled";
      file.cancel();
    }
  };
  const createResumable = () => {
    const _uploader = new Resumable({
      maxChunkRetries: 1,
      testChunks: false,
      ...options
    });
    if (!_uploader.support) {
      throw new Error("Your browser doesn't support chunked uploads. Get a better browser.");
    }
    if (utilsCore.isFunction(target)) {
      uploader.value = target(_uploader);
    } else {
      const _browseEl = composables_unrefOfEl.unrefElement(target.browse);
      if (_browseEl) {
        _uploader.assignBrowse(_browseEl, false);
      }
      if (utilsCore.isDef(target.drop)) {
        const _dropEl = composables_unrefOfEl.unrefElement(target.drop);
        if (_dropEl) {
          _uploader.assignDrop(_dropEl);
        }
      }
      uploader.value = _uploader;
    }
    uploader.value.on("fileAdded", (file) => {
      file.hasUploaded = false;
      files.value.push({
        file,
        status: "uploading",
        progress: 0
      });
      uploader.value.upload();
    });
    uploader.value.on("fileSuccess", (file) => {
      findFile(file).status = "success";
    });
    uploader.value.on("fileError", (file) => {
      findFile(file).status = "error";
    });
    uploader.value.on("fileRetry", (file) => {
      findFile(file).status = "retrying";
    });
    uploader.value.on("fileProgress", (file) => {
      const localFile = findFile(file);
      const progress = file.progress(false);
      if (progress > localFile.progress) {
        localFile.progress = progress;
      }
    });
  };
  composables_tryOnMounted.tryOnMounted(() => {
    createResumable();
  });
  return {
    files,
    uploader,
    findFile,
    cancelFile
  };
}
exports.useResumableUploader = useResumableUploader;
//# sourceMappingURL=useResumableUploader.cjs.map

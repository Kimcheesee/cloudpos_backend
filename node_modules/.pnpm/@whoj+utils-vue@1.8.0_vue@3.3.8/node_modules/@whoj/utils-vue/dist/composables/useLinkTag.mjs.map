{"version":3,"file":"useLinkTag.mjs","sources":["../../src/composables/useLinkTag.ts"],"sourcesContent":["import { ref, watch } from 'vue-demi';\nimport type { Optional } from '@whoj/utils-types';\nimport { getDocument, noop, objectEntries } from '@whoj/utils-core';\nimport type { ComputedRefable } from '../types';\nimport { unrefOf } from './unrefOf';\nimport { listenEvent } from './listenEvent';\nimport { tryOnMounted } from './tryOnMounted';\nimport { tryOnUnmounted } from './tryOnUnmounted';\n\ntype BuiltInLinkElAttrs = Pick<HTMLLinkElement, 'as' | 'rel' | 'type' | 'media'>;\ninterface ConfigurableDocument {\n  document?: Document;\n}\n\nexport interface UseLinkTagOptions extends ConfigurableDocument, Optional<BuiltInLinkElAttrs> {\n  // id of the link tag\n  id?: string;\n\n  immediate?: boolean;\n\n  manual?: boolean;\n\n  blocking?: 'render';\n\n  crossOrigin?: 'anonymous' | 'use-credentials';\n\n  referrerPolicy?: 'no-referrer' | 'no-referrer-when-downgrade' | 'origin' | 'origin-when-cross-origin' | 'unsafe-url';\n\n  attrs?: Record<string, string>;\n}\n\nlet _id = 0;\n\nexport function useLinkTag(href: ComputedRefable<string>, onLoaded: (el: HTMLLinkElement) => void = noop, options: UseLinkTagOptions = {}) {\n  const {\n    as,\n    media,\n    crossOrigin,\n    referrerPolicy,\n    blocking,\n    immediate = true,\n    manual = false,\n    attrs = {},\n    type = 'text/css',\n    rel = 'stylesheet',\n    id = `use_link_tag_${++_id}`,\n    document = getDocument()\n  } = options;\n\n  const linkTag = ref<HTMLLinkElement>();\n  const loaded = ref<boolean>();\n\n  let _promise: Promise<HTMLLinkElement | boolean> | null = null;\n\n  const _evtListeners: Record<string, () => void> = {};\n\n  const findLinkEl = () => document!.querySelector<HTMLLinkElement>(`link[id=\"${id}\"]`);\n\n  const loadLink = (waitForLoad: boolean): Promise<HTMLLinkElement | boolean> => new Promise((resolve, reject) => {\n    const resolveWithElement = (el: HTMLLinkElement) => {\n      linkTag.value = el;\n      resolve(el);\n      return el;\n    };\n\n    // For SSR Support.\n    if (!document) {\n      resolve(false);\n      return;\n    }\n\n    // Local variable defining if the <link> tag should be appended or not.\n    let shouldAppend = false;\n\n    let el = findLinkEl();\n\n    // If not found, prepare the element for appending\n    if (!el) {\n      el = document.createElement('link');\n      el.id = id;\n      el.rel = rel;\n      el.type = type;\n      el.href = unrefOf(href);\n\n      // Optional attributes\n      if (as) {\n        el.as = as;\n      }\n      if (media) {\n        el.media = media;\n      }\n      if (crossOrigin) {\n        el.crossOrigin = crossOrigin;\n      }\n      if (referrerPolicy) {\n        el.referrerPolicy = referrerPolicy;\n      }\n      if (blocking) {\n        attrs.blocking = blocking;\n      }\n\n      objectEntries(attrs).forEach(([name, value]) => el?.setAttribute(name, value));\n\n      // Enables shouldAppend\n      shouldAppend = true;\n    } else if (el.hasAttribute('data-loaded')) {\n      resolveWithElement(el);\n    }\n\n    // Event listeners\n    _evtListeners.error = listenEvent<ErrorEvent>(el, 'error', event => reject(event));\n    _evtListeners.abort = listenEvent<UIEvent>(el, 'abort', event => reject(event));\n    _evtListeners.load = listenEvent(el, 'load', () => {\n      el!.setAttribute('data-loaded', 'true');\n\n      loaded.value = true;\n      onLoaded(el!);\n      resolveWithElement(el!);\n    });\n\n    // Append the <script> tag to head.\n    if (shouldAppend) {\n      el = document.head.appendChild(el);\n    }\n\n    // If script load awaiting isn't needed, we can resolve the Promise.\n    if (!waitForLoad) {\n      resolveWithElement(el);\n    }\n  });\n\n  const load = (waitForLoad = true): Promise<HTMLLinkElement | boolean> => {\n    if (!_promise) {\n      _promise = loadLink(waitForLoad);\n    }\n\n    return _promise;\n  };\n\n  const unload = () => {\n    if (!document) {\n      return;\n    }\n\n    _promise = null;\n\n    if (linkTag.value) {\n      linkTag.value = undefined;\n    }\n\n    const el = findLinkEl();\n    if (el) {\n      objectEntries(_evtListeners).forEach(([name, unregister]) => {\n        unregister();\n      });\n      document.head.removeChild(el);\n    }\n    loaded.value = undefined;\n  };\n\n  const update = () => {\n    const el = findLinkEl();\n    if (el) {\n      el.href = unrefOf(href);\n    }\n  };\n\n  if (immediate && !manual) {\n    tryOnMounted(load);\n  }\n\n  if (!manual) {\n    tryOnUnmounted(unload);\n  }\n\n  watch(\n    () => unrefOf(href),\n    update,\n    { immediate: true, flush: 'post' }\n  );\n\n  return { linkTag, loaded, load, unload };\n}\n\nexport type UseLinkTagReturn = ReturnType<typeof useLinkTag>;\n"],"names":["el"],"mappings":"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"}